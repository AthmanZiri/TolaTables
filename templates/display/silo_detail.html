{% extends "base.html" %} 

{% load render_table from django_tables2 %}

{% block page_title %} <a href="/silo_edit/{{ silo.id }}">{{ silo.name }}</a> <br /><small><p>{{ silo.description|default:"" }}</p></small>{% endblock %}

{% block content %}
<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#tableOptions" aria-expanded="false" aria-controls="tableOptions">
  Show Options
</button>

<div class="collapse" id="tableOptions">
    <hr />
    <h4> +/- Update, Pull, or Push Your Data <a href="/set_unique_columns/{{ id }}/" id="unique_cols_selection_btn" class="btn btn-primary">First Assign a Unique Column</a></h4> 

    <div class="row" style="padding-top:5px;">
        <div class="col-md-4">
            <a href="{% url 'updateMergedTable' id %}" id="update_silo_btn" class="btn btn-primary">Update Table</a>
            or
            <a href="#" id="auto_pull_btn" class="btn btn-primary">Setup AutoPull</a>
        </div>
        <div class="col-md-8">
            <span>Table data will be updated from the source at ...</span>
            {% for read in silo.reads.all %}
                {% if read.autopull_frequency %}
                    <span class="label label-info" id="auto_pull_lbl">Autopull setup from {{read.read_name }} at {{read.read_url}}</span>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <div class="row" style="padding-top:5px;">
        <div class="col-md-3">
            <a href="#" id="auto_push_btn" class="btn btn-primary">Auto Push Table</a>
        </div>
        <div class="col-md-9">
            <span>Table data will be updated from the source at ...</span>
        </div>
    </div>

    <div class="row" style="padding-top:5px;">
        <div class="col-md-3">
            <a href="{% url 'acitivity_push' id %}" id="push_to_activity_btn" class="btn btn-primary">Send To Tola Activity</a>
        </div>
        <div class="col-md-9">
            <span>Table data will be updated from the source at ...</span>
        </div>
    </div>


    <hr />
    <h4> +/- Edit Table<br /><small>Edit or Delete each row below using the buttons on the left.</small></h4>
    <p>
    <a href="/edit_columns/{{ id }}/" class="btn btn-primary">Edit or Delete columns</a>
    <a href="/new_column/{{ id }}/" class="btn btn-primary">Add New Column</a>
    </p>

    <form class="form-inline" action="{% url 'updateColumn' %}"  method="POST">
        {% csrf_token %}
        <input name="silo_id" value="{{silo.pk}}" type="hidden">
        <div class="form-group">
            <label for="all_cols">Set new value  for a column</label>
            <select name="update_col" class="form-control">
                <option value="-1">Select Column</option>
                {% for col in cols %}
                    <option value="{{ col }}">{{ col }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <input type="text" class="form-control" id="new_val" name="new_val" placeholder="New Value">
        </div>
        <button type="submit" class="btn btn-default">Submit</button>
    </form>
    <hr />
</div>
<span class="label label-info" id="unique_col_lbl"></span>

<div id="table_data">
    {% render_table silo_table %}
</div>


<br />
{% comment %}
    {% for row in silo_table %}
        {% for k,v in row.items %}
            {{ k }} : {{ v }} <br />
        {% endfor %}
    {% endfor %}
{% endcomment %}

<div class="modal fade" id="unique_cols_selection_modal" tabindex="-1" role="dialog" aria-labelledby="pr_items_modal_div_label" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Choose unique column(s) for this table.</h4> <br />
                <p>
                A Unique Column is any column in your Tola Table that does not have the same data in any of its rows; each row in the column is unique and does not repeat
                </p>
            </div>
            <div class="modal-body" id="unique_cols_selection_modal_body_div">
                <label for="silo_cols">Unique Columns</label>
                <select multiple id="silo_cols_multi_select" name="silo_cols" class="form-control input-sm" style="width: 100%;">
                    {% for col in cols %}
                        {% for unique_field in silo.unique_fields.all %}
                            {% if col  == unique_field.name %}
                                <option value="{{ col }}" selected="True">{{ unique_field.name }}</option>
                            {% else %}
                                <option value="{{ col }}">{{ col }}</option>
                            {% endif %}
                        {% empty %}
                            <option value="{{ col }}">{{ col }}</option>
                        {% endfor %}
                    {% endfor %}
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" id="add_unique_cols_save_btn" class="btn btn-primary" data-dismiss="modal">Save</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="failed_project_agreements_modal" tabindex="-1" role="dialog" aria-labelledby="failed_project_agreements_modal" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Project Agreements Failed to Post</h4>
            </div>
            <div class="modal-body" id="failed_project_agreements_modal_body">
            </div>
        </div>
    </div>
</div>


{% endblock content %}

{% block extra_js_in_body %}
<script type="text/javascript">
"use strict";
    $(document).ready(function() {
        //$('#table_data').on('click', 'th', function(e) {
            //e.preventDefault();
            //var url = `{% url 'siloDetail' id %}` + $(this).children('a').attr('href');
            //window.location = url ;
        //});
        var unique_col = $("#silo_cols_multi_select").val();
        if (unique_col == null || unique_col == "null") {
            unique_col = "not specified";
        }
        $("#unique_col_lbl").text("Unique Column: " + unique_col);
        $("#silo_cols_multi_select").select2();
        $("body").on("click", "#unique_cols_selection_btn", function(e) {
            e.preventDefault();
            $("#unique_cols_selection_modal").modal('show');
        });
        
        $("#unique_cols_selection_modal").on("click", "#add_unique_cols_save_btn", function(e) {
            e.preventDefault();
            var url = "{% url 'add_unique_fields_to_silo' %}" + "/";
            var params = {"silo_id": `{{ id }}`, "fields": $("select#silo_cols_multi_select").val()};
            //console.log(params);
            $.post(url, params)
            .done(function(data, textStatus, jqXHR) {
                console.log(JSON.stringify(data));
            });
        });
        $("body").on("click", "#push_to_activity_btn", function(e) {
            e.preventDefault();
            var url = $(this).attr("href");
            console.log(url);

            $.ajax({
                url: url,
                type: 'post',
                //data: {
                //   'bla': 'bla bla',
                //},
                headers: {
                    'Authorization': 'Token xxxxx',
                },
                dataType: 'json',
                complete: function(data, status) {
                    if (status == "success") {
                        var failed_agreements = data.responseJSON["data"];
                        console.log(failed_agreements);
                        /*
                        for (var i=0; i<failed_agreements.length; i++){
                            $.each(failed_agreements[i], function(k,v) {
                                console.log(k + ": " + v);
                            });
                        }
                        */
                        var table = new tableObject(failed_agreements);
                        $("#failed_project_agreements_modal_body").empty();
                        $("#failed_project_agreements_modal_body").append(table);
                        $("#failed_project_agreements_modal").modal('show');
                    } else {
                        console.log("something weird happened");
                    }
                }
            });

        });
    });
</script>
{% endblock %}